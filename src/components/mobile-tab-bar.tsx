import { useNavigate, useRouterState } from '@tanstack/react-router'
import { HugeiconsIcon } from '@hugeicons/react'
import {
  BotIcon,
  Chat01Icon,
  Home01Icon,
  Settings01Icon,
} from '@hugeicons/core-free-icons'
import { useCallback, useEffect, useLayoutEffect, useRef, useState } from 'react'
import type { TouchEvent } from 'react'
import { cn } from '@/lib/utils'
import { hapticTap } from '@/lib/haptics'

/** Height constant for consistent bottom insets on mobile routes with tab bar */
export const MOBILE_TAB_BAR_OFFSET = 'var(--tabbar-h, 80px)'

/**
 * Z-index layer map (documented for maintainability):
 *   z-40  — tab bar (below everything interactive)
 *   z-50  — chat composer input area
 *   z-60  — quick menus, modal sheets, overlays
 *   z-70  — composer wrapper (fixed on mobile)
 */

type TabItem = {
  id: string
  label: string
  icon: typeof Chat01Icon
  to: string
  match: (path: string) => boolean
}

const TABS: TabItem[] = [
  {
    id: 'dashboard',
    label: 'Dashboard',
    icon: Home01Icon,
    to: '/dashboard',
    match: (p) => p.startsWith('/dashboard'),
  },
  {
    id: 'agents',
    label: 'Agent Hub',
    icon: BotIcon,
    to: '/agent-swarm',
    match: (p) => p.startsWith('/agent-swarm') || p.startsWith('/agents'),
  },
  {
    id: 'chat',
    label: 'Chat',
    icon: Chat01Icon,
    to: '/chat/main',
    match: (p) => p.startsWith('/chat') || p === '/new' || p === '/',
  },
  {
    id: 'settings',
    label: 'Settings',
    icon: Settings01Icon,
    to: '/settings',
    match: (p) => p.startsWith('/settings'),
  },
]

export function MobileTabBar() {
  const navigate = useNavigate()
  const pathname = useRouterState({ select: (s) => s.location.pathname })
  const navRef = useRef<HTMLElement>(null)

  // Drag-to-switch state
  const dragStartXRef = useRef<number | null>(null)
  const dragStartTimeRef = useRef<number | null>(null)
  const [isDragging, setIsDragging] = useState(false)

  // isChatRoute = inside a specific conversation (not /chat/main)
  const isChatRoute =
    pathname.startsWith('/chat/') && pathname !== '/chat/main'

  // Drag-to-switch: horizontal swipe across pill switches tabs
  const handlePillTouchStart = useCallback(
    (event: TouchEvent<HTMLElement>) => {
      dragStartXRef.current = event.touches[0]?.clientX ?? null
      dragStartTimeRef.current = Date.now()
      setIsDragging(false)
    },
    [],
  )

  const handlePillTouchMove = useCallback(
    (_event: TouchEvent<HTMLElement>) => {
      if (dragStartXRef.current !== null) {
        setIsDragging(true)
      }
    },
    [],
  )

  const handlePillTouchEnd = useCallback(
    (event: TouchEvent<HTMLElement>) => {
      const startX = dragStartXRef.current
      dragStartXRef.current = null
      setIsDragging(false)

      if (startX === null) return
      const endX = event.changedTouches[0]?.clientX ?? startX
      const delta = endX - startX
      const pillWidth = navRef.current?.getBoundingClientRect().width ?? 200
      const threshold = pillWidth * 0.3

      if (Math.abs(delta) < threshold) return

      const currentIdx = TABS.findIndex((tab) => tab.match(pathname))
      const nextIdx =
        delta < 0
          ? Math.min(currentIdx + 1, TABS.length - 1) // swipe left → next tab
          : Math.max(currentIdx - 1, 0) // swipe right → prev tab

      if (nextIdx !== currentIdx && nextIdx >= 0 && nextIdx < TABS.length) {
        hapticTap()
        void navigate({ to: TABS[nextIdx]!.to })
      }
    },
    [navigate, pathname],
  )

  // Measure pill for --tabbar-h (~80px total = pill + bottom offset)
  useLayoutEffect(() => {
    const root = document.documentElement
    const measure = () => {
      const el = navRef.current
      if (!el) return
      const rect = el.getBoundingClientRect()
      if (rect.height <= 0) return
      // pill height + 16px above safe area + safe area itself — use 80px as total scroll clearance
      const total = Math.ceil(rect.height) + 24
      root.style.setProperty('--tabbar-h', `${total}px`)
    }

    measure()
    const ro = new ResizeObserver(measure)
    if (navRef.current) ro.observe(navRef.current)
    window.addEventListener('resize', measure)
    return () => {
      ro.disconnect()
      window.removeEventListener('resize', measure)
    }
  }, [])

  // Keep --tabbar-h fresh when tab bar hides/shows
  useEffect(() => {
    const root = document.documentElement
    if (isChatRoute) {
      // Tab bar hidden in chat routes — remove extra padding
      root.style.setProperty('--tabbar-h', '0px')
    } else {
      // Restore measured value on next paint
      const el = navRef.current
      if (el) {
        const rect = el.getBoundingClientRect()
        if (rect.height > 0) {
          root.style.setProperty('--tabbar-h', `${Math.ceil(rect.height) + 24}px`)
        }
      }
    }
  }, [isChatRoute])

  return (
    <nav
      ref={navRef}
      className={cn(
        // Pill: fixed bottom center, auto width, not full-width
        'fixed bottom-0 left-1/2 z-40 md:hidden',
        '-translate-x-1/2',
        // Vertical position: above home indicator
        'mb-[calc(env(safe-area-inset-bottom,16px)+8px)]',
        // Frosted glass pill
        'bg-white/85 dark:bg-neutral-900/85 backdrop-blur-2xl',
        'rounded-full',
        'border border-white/40 dark:border-white/10',
        'shadow-[0_8px_32px_rgba(0,0,0,0.18)] dark:shadow-[0_8px_32px_rgba(0,0,0,0.5)]',
        // Inner padding
        'px-3 py-2',
        // Hide/show animation
        'transition-transform duration-300 ease-in-out',
        isChatRoute
          ? 'translate-y-[120%]'
          : 'translate-y-0',
        isDragging ? 'cursor-grabbing' : '',
      )}
      aria-label="Mobile navigation"
      onTouchStart={handlePillTouchStart}
      onTouchMove={handlePillTouchMove}
      onTouchEnd={handlePillTouchEnd}
    >
      <div className="flex items-center gap-1">
        {TABS.map((tab, idx) => {
          const isActive = tab.match(pathname)
          const isCenter = tab.id === 'chat'
          const circleSize = isCenter && isActive ? 'size-11' : isActive ? 'size-10' : 'size-11'

          return (
            <button
              key={tab.id}
              type="button"
              onClick={() => {
                // Don't fire navigate if this was a drag swipe
                if (!isDragging) {
                  hapticTap()
                  void navigate({ to: tab.to })
                }
              }}
              aria-current={isActive ? 'page' : undefined}
              aria-label={tab.label}
              className={cn(
                // 44x44 touch target, icon centered
                'flex items-center justify-center',
                'size-11 rounded-full',
                'transition-all duration-200 active:scale-90',
                'select-none touch-manipulation',
              )}
              data-tab-idx={idx}
            >
              <span
                className={cn(
                  'flex items-center justify-center rounded-full transition-all duration-200',
                  circleSize,
                  isActive
                    ? 'bg-accent-500 text-white shadow-sm'
                    : 'text-neutral-400 dark:text-neutral-500',
                )}
              >
                <HugeiconsIcon
                  icon={tab.icon}
                  size={isCenter ? 22 : 20}
                  strokeWidth={isActive ? 2 : 1.6}
                />
              </span>
            </button>
          )
        })}
      </div>
    </nav>
  )
}
